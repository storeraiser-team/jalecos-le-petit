{%- liquid
  assign swatch_file_extension = 'png'
  assign option_index = forloop.index
-%}

{%- capture size_chart_title -%}
  {{ 'products.general.size_chart' | t }} <svg aria-hidden="true" focusable="false" role="presentation" class="icon icon-size-chart" viewBox="0 0 64 64"><path d="M22.39 33.53c-7.46 0-13.5-3.9-13.5-8.72s6-8.72 13.5-8.72 13.5 3.9 13.5 8.72a12 12 0 0 1-.22 1.73"/><ellipse cx="22.39" cy="24.81" rx="3.28" ry="2.12"/><path d="M8.89 24.81V38.5c0 7.9 6.4 9.41 14.3 9.41h31.92V33.53H22.39m24.39 0v7.44m-8.13-7.44v7.44m-8.13-7.44v7.44m-8.13-7.44v7.44"/></svg>
{%- endcapture -%}

{%- liquid
  assign is_size = false
  assign size_trigger = 'products.general.size_trigger' | t | downcase
  assign downcased_option = option.name | downcase

  if downcased_option contains size_trigger
    assign is_size = true
  endif
-%}

<div class="variant-wrapper js" data-type="button">

  {% assign product_group = product.metafields.custom.agrupamento_de_produtos %}

  {% if product_group %}
    <style>
      .product-color-swatches {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .product-color-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .product-color-input {
        display: none;
      }
      
      .product-color-swatch {
        display: block;
        width: 3rem;
        height: 3rem;
        border: 1px solid #E8E8E8;
        border-radius: 0.25rem;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .product-color-swatch:hover {
        box-shadow: 0 0 0 2px #212121;
      }
      
      .product-color-input:checked + .product-color-swatch {
        box-shadow: 0 0 0 2px #212121;
      }
      
      .product-color-swatch img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .product-color-placeholder {
        width: 100%;
        height: 100%;
        background-color: #F3F4F6;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .product-color-placeholder span {
        font-size: 0.75rem;
        line-height: 1rem;
      }
      
      .variant__label {
        display: block;
        margin-bottom: 0.5rem;
      }
      
      .variant__label-info {
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #6b7280;
      }
      
      .variant-input-wrap {
        margin-bottom: 1.5rem;
      }
      
      .variant-input {
        margin-bottom: 0.5rem;
      }
      
      .variant__input--color-swatch {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .color-swatch {
        display: block;
        width: 2.5rem;
        height: 2.5rem;
        border: 1px solid #E8E8E8;
        border-radius: 0.25rem;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .color-swatch:hover {
        box-shadow: 0 0 0 2px #FF5B00;
      }
      
      .variant__input--color-swatch input:checked + .color-swatch {
        box-shadow: 0 0 0 2px #FF5B00;
      }
      
      .color-swatch img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    </style>

    <label class="variant__label">
      {% assign color_name = '' %}
      {% liquid
        assign colors = product.metafields.shopify['color-pattern']
        for color in colors.value
          if forloop.index > 1
            assign color_name = color_name | append: '/' | append: color.label
          else
            assign color_name = color.label
          endif
        endfor 
      %}

      Escolha uma cor â€¢ {{ color_name }}
    </label>

    <div class="product-color-swatches" data-product-color-selector>
      {% for prod in product_group.value.produtos.value %}
        <div class="product-color-item">
          <input
            type="radio"
            name="product-color-group-{{ section_id }}"
            id="product-color-{{ section_id }}-{{ prod.id }}"
            value="{{ prod.id }}"
            class="product-color-input"
            {% if prod.id == product.id %}
              checked
            {% endif %}
            data-product-color-input
            data-product-id="{{ prod.id }}"
            data-product-url="{{ shop.url }}{{ prod.url }}"
            data-color-name="{{ color_name | escape }}"
          >
          <label
            for="product-color-{{ section_id }}-{{ prod.id }}"
            class="product-color-swatch"
          >
            {% assign color_hex = '' %}
            {% liquid
              assign colors = prod.metafields.shopify['color-pattern']
              for color in colors.value
                assign color_hex = color.color
              endfor
            %}

            {% if color_hex %}
              <div style="width: 100%; height: 100%; background-color: {{ color_hex }};"></div>
            {% else %}
              <div class="product-color-placeholder">
                <span>{{ prod.title | slice: 0, 2 | upcase }}</span>
              </div>
            {% endif %}
          </label>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <label class="variant__label{% if option.name == 'Default' or option.name == 'Title' %} hidden-label{% endif %}{% unless variant_labels %} hidden-label{% endunless %}"
    for="ProductSelect-{{ section_id }}-{{ product.id }}-option-{{ forloop.index0 }}">
    {{ option.name }}
    {%- if connect_to_sizechart and is_size -%}
      <span class="variant__label-info">
        &mdash;
        {%- render
          'tool-tip-trigger',
          title: size_chart_title,
          content: section.blocks[sizechart_index].settings.size_chart.content,
          context: 'size-chart'
        -%}
      </span>
    {%- endif -%}
    {%- if is_color -%}
      <span class="variant__label-info">
        &mdash;
        <span
          data-variant-color-label
          data-index="{{ forloop.index0 }}"
          data-option-index="{{ color_option_index }}">
          {{ option.selected_value }}
        </span>
      </span>
    {%- endif -%}
  </label>

  <fieldset class="variant-input-wrap"
    name="{{ option.name }}"
    data-index="option{{ option_index }}"
    data-handle="{{ option.name | handleize }}"
    id="ProductSelect-{{ section_id }}-{{ product.id }}-option-{{ forloop.index0 }}">
    <legend class="hide">{{ option.name }}</legend>
    {%- for value in option.values -%}
      {%- liquid
        assign product_available = true
        if product.options.size == 1 and block.settings.product_dynamic_variants_enable
          assign product_available = product.variants[forloop.index0].available
        endif
      -%}
      <div
        class="variant-input"
        data-index="option{{ option_index }}"
        data-value="{{ value | escape }}">
        <input type="radio"
          {% if option.selected_value == value %} checked="checked"{% endif %}
          form="{{ form_id }}"
          value="{{ value | escape }}"
          data-index="option{{ option_index }}"
          name="{{ option.name }}"
          data-variant-input
          class="{% unless product_available %} disabled{% endunless %}{% if is_color %} variant__input--color-swatch{% endif %}"
          {% if is_color %} data-color-name="{{ value | escape }}"{% endif %}
          {% if is_color %} data-color-index="{{ color_option_index }}"{% endif %}
          id="ProductSelect-{{ section_id }}-{{ product.id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}">
        {%- if is_color -%}
          {%- if value.swatch -%}
            {% comment %} Handle color swatches from Liquid swatch drop {% endcomment %}
            {%- liquid
              assign color_image = value.swatch.image | image_url: width: 50
              assign color_swatch_fallback = value.swatch.color
            -%}
            <label
              for="ProductSelect-{{ section_id }}-{{ product.id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}"
              class="color-swatch color-swatch--{{ value | handle }}{% unless product_available %} disabled{% endunless %}"
              style="background-color: {{ color_swatch_fallback }};{% if value.swatch.image %} background-image: url({{ color_image }});{% endif %}"
            >
              {{ value | escape }}
            </label>
          {%- else -%}
            {% comment %} Handle legacy color swatches generated color product option + product images {% endcomment %}
            {%- liquid
              assign color_file_name = value | handle | append: '.' | append: swatch_file_extension
              assign color_image = color_file_name | file_img_url: '50x50' | prepend: 'https:' | split: '?' | first
              assign color_swatch_fallback = value | split: ' ' | last | handle
            -%}
            <label
              for="ProductSelect-{{ section_id }}-{{ product.id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}"
              class="color-swatch color-swatch--{{ value | handle }}{% unless product_available %} disabled{% endunless %}"
              style="background-color: {{ color_swatch_fallback }};{% if images[color_file_name] != blank %}  background-image: url({{ color_image }});{% endif %}"
            >
              {{ value | escape }}
            </label>
          {%- endif -%}
        {%- else -%}
          <label for="ProductSelect-{{ section_id }}-{{ product.id }}-option-{{ option.name | handleize }}-{{ value | url_encode }}"{% unless product_available %} class="disabled"{% endunless %}>{{ value | escape }}</label>
        {%- endif -%}
      </div>
    {%- endfor -%}
  </fieldset>
</div>
